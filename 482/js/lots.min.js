var Lots={onOfferEditorButtonClick:function(){var t=$(this),e=t.closest("form"),a=e.find(".js-btn-save"),o=e.find(".js-btn-delete"),i=e.find(".js-btn-delete-cancel"),n=e.find('input[name="deleted"]');if(t.is(o)){if(!o.hasClass("confirm"))return o.addClass("confirm").attr("data-text-delete",o.text()).text(o.attr("data-text-confirm")),a.addClass("hidden"),i.removeClass("hidden"),!1;n.val("1")}else if(t.is(i))return n.val(""),o.removeClass("confirm").text(o.attr("data-text-delete")),a.removeClass("hidden"),i.addClass("hidden"),!1;return!0},processOfferEditorErrors:function(t,e){var a,o,i,n;if(t.find(".form-group.has-error").each((function(){a=$(this),o=a.find(".help-block"),(i=o.data("help"))?o.html(i):o.addClass("hidden"),a.removeClass("has-error")})),e){var s=[];for(n=0;n<e.length;++n)if((a=t.find('[name="'+e[n][0]+'"]').closest(".form-group")).length){a.addClass("has-error"),(o=a.find(".help-block")).length||(o=$("<p>",{class:"help-block"}),a.append(o)),void 0===o.data("help")&&o.data("help",o.html()),o.text(e[n][1]).removeClass("hidden");var r=a.data("locale");r&&s.push(r)}if(s.length>0){var l=Lots.getOfferEditorActiveLocale(t);l&&-1!=s.indexOf(l)||t.find(".js-locale-switcher").filter('[data-locale="'+s[0]+'"]').click()}}},onOfferEditorSubmit:function(){var t=$(this),e=t.serializeObject(),a=t.find('input[type="submit"], button[type="submit"]'),o=!1;return a.prop("disabled",!0),$.ajax({type:"POST",url:app.processRoute(t.attr("action")),data:e,dataType:"json",error:onAjaxError,success:function(e){e.error&&showMessage(e.error,!0),e.done?(o=!0,e.url&&(window.location.href=e.url)):Lots.processOfferEditorErrors(t,e.errors)},complete:function(){o||a.prop("disabled",!1)}}),!1},updateLotFields:function(t,e){if(t&&1==t.length){var a,o,i,n,s,r,l,d,c={},f=t.data("fields");if(f&&f.length){for(o=0;o<f.length;++o){if(n=f[o].id,s=f[o].conditions,l=(r=t.find('.lot-field[data-id="'+n+'"]')).find(".lot-field-input"),s.length){for(d=!1,i=0;i<s.length;++i)if(a=s[i].id,c.hasOwnProperty(a)&&s[i].list.indexOf(c[a])>=0){d=!0;break}}else d=!0;d&&(c[n]=l.val().toLowerCase()),r.toggleClass("hidden",!d),l.prop("disabled",!d)}var u=Lots.getOfferEditorActiveLocale(t);if(u){var h=t.find(".lot-fields-multilingual"),p=h.find(".lot-field");p.not('[data-locale="'+u+'"]').addClass("hidden");var v=p.not(".hidden"),m="modal-custom-bg-block-top";p.filter("."+m).removeClass(m),v.first().addClass(m),h.toggleClass("hidden",!v.length)}e||t.closest(".showcase-filters").trigger("filter.fp.showcase")}}},getOfferEditorActiveLocale:function(t){var e=t.find(".js-locale-switcher.active").data("locale");return e||!1},onLotFieldChange:function(){var t=$(this),e=t.closest(".lot-field"),a=t.val();if(e.data("value")!==a){e.data("value",a);var o=e.closest(".lot-fields");Lots.updateLotFields(o)}},updateRangeValue:function(t){var e=t.closest(".lot-field"),a=Number(e.find(".range-min").val())||0,o=Number(e.find(".range-max").val())||0,i=a||o?(a||"")+":"+(o||""):"";t.val(i).data({min:a,max:o})},onLotFieldRangeChange:function(){var t=$(this).closest(".lot-field").find(".range-value");Lots.updateRangeValue(t),t.change()},updateRadioButtons:function(t){var e="btn-dark",a="btn-gray",o=t.find(".lot-field-input").val();t.find("button."+e).removeClass(e).addClass(a),t.find("button").each((function(){var t=$(this);t.val()==o&&t.addClass(e).removeClass(a)}))},onLotFieldRadioChange:function(){var t=$(this),e=t.closest(".lot-field-radio-box");e.find(".lot-field-input").val(t.val()).change(),t.blur(),Lots.updateRadioButtons(e)},activateLotFields:function(){var t=$(".lot-fields:not(.live)");return t.length&&(t.addClass("live"),t.on("change",".lot-field-input",Lots.onLotFieldChange),t.find(".range-value").each((function(){Lots.updateRangeValue($(this))})),t.on("change input",".lot-field-range",Lots.onLotFieldRangeChange),t.find(".lot-field-radio-box").each((function(){Lots.updateRadioButtons($(this))})),t.on("click",".lot-field-radio-box button",Lots.onLotFieldRadioChange)),t},onOfferEditorLocaleSwitcherClick:function(){var t=$(this),e=t.closest(".lot-fields");e.find(".js-locale-switcher").removeClass("active"),t.addClass("active"),Lots.updateLotFields(e)},activatePriceTable:function(t){var e=$(".js-calc-table");if(e.length){var a,o=e.find(".js-calc-table-body"),i=e.closest("form").find('input[name="price"]'),n={},s=0;i.on("input",(function(){clearTimeout(a),a=setTimeout((function(){var t=r();t>0?c(t):l("")}),500)}))}function r(){return strToFloat(i.val())}function l(t){o.html(t),o.removeClass("blur"),e.toggleClass("hidden",!t.length)}function d(t){var e=$("<tbody/>");for(var a in t)if(t.hasOwnProperty(a)){var o=t[a],i=$("<tr/>").append($("<th/>").text(o.name)).append($("<td/>").text(o.price+" "+o.unit));e.append(i)}return e}function c(e){n.hasOwnProperty(e)?l(d(n[e]).html()):(o.html().trim().length&&o.addClass("blur"),$.ajax({type:"POST",url:app.processRoute("/lots/calc"),data:{nodeId:t,price:e},dataType:"json",error:onAjaxErrorCallback((function(){r()===e&&l('<span class="text-danger">'+app.t("request.fail.error")+"</span>")})),success:function(t){var a=t.error||!1;a||(t.methods.sort((function(t,e){return t.pos-e.pos})),function(t,e){s>=1e3&&(n={},s=0),n[t]||s++,n[t]=e}(e,t.methods)),r()===e&&l(a?$("<span/>",{class:"text-danger"}).text(a):d(n[e]).html())}}))}},onOfferEditorAutoDeliverySwitcherClick:function(){var t=$(this),e=t.prop("checked"),a=t.closest("form");a.find(".auto-delivery-box").toggleClass("hidden",!e),a.find('input[name="amount"]').closest(".form-group").toggleClass("hidden",e)},activateOfferEditor:function(){var t=$(".form-offer-editor");if(t.length){var e=t.find('input[name="node_id"]').val();Lots.activateLotFields(),Lots.activatePriceTable(e),t.on("submit",Lots.onOfferEditorSubmit),t.on("click","button",Lots.onOfferEditorButtonClick),t.on("click",".js-locale-switcher",Lots.onOfferEditorLocaleSwitcherClick),t.on("change",'input[name="auto_delivery"]',Lots.onOfferEditorAutoDeliverySwitcherClick)}},raiseOffers:function(t,e,a){var o=$(this);return o.prop("disabled",!0),$.ajax({type:"POST",url:app.processRoute("/lots/raise"),data:{game_id:t,node_id:e,node_ids:a},dataType:"json",error:onAjaxError,success:function(t){t.msg&&showMessage(t.msg,t.error);var e="modal-raise-nodes";if(t.modal){var a=getModal(e,{title:app.t("lot.categories.modal.title"),size:"sm"});a.find(".modal-body").html(t.modal),function(t){t.find(".js-lot-raise-ex").click((function(){var t=$(this).closest(".raise-box"),e=t.data("game"),a=t.data("node"),o=[];t.find('input[type="checkbox"]').each((function(){this.checked&&o.push(this.value)})),Lots.raiseOffers.apply(this,[e,a,o])}))}(a),a.modal("handleUpdate"),a.modal("show")}else t.error||$("."+e).modal("hide")},complete:function(){o.prop("disabled",!1)}}),!1}};$((function(){var t=$("#content");t.hasClass("content-lots-offeredit")&&Lots.activateOfferEditor(),t.hasClass("content-lots-trade")&&t.on("click",".js-lot-raise",(function(){var t=$(this);Lots.raiseOffers.apply(this,[t.data("game"),t.data("node")])})),t.hasClass("content-lots-node")&&$(".showcase-filters").on("initfilter.fp.showcase",(function(){Lots.activateLotFields().each((function(){Lots.updateLotFields($(this),!0)}))}))}));